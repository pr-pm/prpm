import { KarenReview, getKarenEmoji } from './karen-config';

export function formatReviewMarkdown(review: KarenReview, repoName: string): string {
  const emoji = getKarenEmoji(review.score.total);

  return `# ğŸ”¥ Karen's Brutally Honest Review

**Repository:** ${repoName}
**Karen Score:** ${emoji} **${review.score.total}/100** - "${review.score.grade}"
**Reviewed:** ${new Date(review.score.timestamp).toLocaleString()}

---

## The Reality Check

${review.summary}

---

## Score Breakdown

| Category | Score | Assessment |
|----------|-------|------------|
| ğŸ­ Bullshit Factor | ${review.score.breakdown.bullshitFactor}/20 | ${getScoreAssessment(review.score.breakdown.bullshitFactor, 20)} |
| âš™ï¸ Actually Works | ${review.score.breakdown.actuallyWorks}/20 | ${getScoreAssessment(review.score.breakdown.actuallyWorks, 20)} |
| ğŸ’ Code Quality Reality | ${review.score.breakdown.codeQualityReality}/20 | ${getScoreAssessment(review.score.breakdown.codeQualityReality, 20)} |
| âœ… Completion Honesty | ${review.score.breakdown.completionHonesty}/20 | ${getScoreAssessment(review.score.breakdown.completionHonesty, 20)} |
| ğŸ¯ Practical Value | ${review.score.breakdown.practicalValue}/20 | ${getScoreAssessment(review.score.breakdown.practicalValue, 20)} |

---

## What Actually Works

${review.whatActuallyWorks.length > 0
  ? review.whatActuallyWorks.map(item => `- ${item}`).join('\n')
  : '_Karen is looking... still looking... ğŸ”_'}

---

## The Bullshit Detector Went Off

${formatIssues(review.issues)}

---

## The Bottom Line

> ${review.bottomLine}

---

## Karen's Prescription

${review.prescription.map((item, i) => `${i + 1}. ${item}`).join('\n')}

---

<div align="center">

**Karen Score: ${emoji} ${review.score.total}/100**

ğŸ“„ **[Full Hot Take](.karen/review.md)** | ğŸ¦ **[Share on Twitter](https://twitter.com/intent/tweet?text=${encodeURIComponent(`Karen just roasted my project and gave it a ${review.score.total}/100 ${emoji}\n\n"${review.score.grade}"\n\n${review.bottomLine}\n\n#KarenScore #PRPM`)})**

*Generated by [PRPM Karen](https://github.com/your-org/prompt-package-manager) - Brutally honest code reviews, powered by Claude*

</div>
`;
}

function getScoreAssessment(score: number, max: number): string {
  const percentage = (score / max) * 100;
  if (percentage >= 90) return 'Excellent';
  if (percentage >= 75) return 'Good';
  if (percentage >= 60) return 'Acceptable';
  if (percentage >= 40) return 'Concerning';
  return 'Critical';
}

function formatIssues(issues: any[]): string {
  if (issues.length === 0) {
    return '_Surprisingly, Karen found nothing to complain about here. Shocking._';
  }

  const groupedIssues = {
    critical: issues.filter(i => i.severity === 'critical'),
    high: issues.filter(i => i.severity === 'high'),
    medium: issues.filter(i => i.severity === 'medium'),
    low: issues.filter(i => i.severity === 'low')
  };

  let output = '';

  if (groupedIssues.critical.length > 0) {
    output += '### ğŸš¨ Critical Issues\n\n';
    output += groupedIssues.critical.map(i => formatIssue(i)).join('\n\n');
    output += '\n\n';
  }

  if (groupedIssues.high.length > 0) {
    output += '### âš ï¸ High Priority\n\n';
    output += groupedIssues.high.map(i => formatIssue(i)).join('\n\n');
    output += '\n\n';
  }

  if (groupedIssues.medium.length > 0) {
    output += '### ğŸ“ Medium Priority\n\n';
    output += groupedIssues.medium.map(i => formatIssue(i)).join('\n\n');
    output += '\n\n';
  }

  if (groupedIssues.low.length > 0) {
    output += '<details>\n<summary>ğŸ’¡ Low Priority Issues (click to expand)</summary>\n\n';
    output += groupedIssues.low.map(i => formatIssue(i)).join('\n\n');
    output += '\n</details>\n';
  }

  return output;
}

function formatIssue(issue: any): string {
  let output = `**${issue.category}**: ${issue.message}`;

  if (issue.file) {
    output += `\n- ğŸ“ \`${issue.file}${issue.line ? `:${issue.line}` : ''}\``;
  }

  if (issue.suggestion) {
    output += `\n- ğŸ’¡ **Fix:** ${issue.suggestion}`;
  }

  return output;
}

export function formatPRComment(review: KarenReview, repoName: string, previousScore?: number): string {
  const emoji = getKarenEmoji(review.score.total);
  const scoreDelta = previousScore ? review.score.total - previousScore : null;

  let scoreChange = '';
  if (scoreDelta !== null) {
    if (scoreDelta > 0) {
      scoreChange = ` (ğŸ“ˆ +${scoreDelta} from previous review)`;
    } else if (scoreDelta < 0) {
      scoreChange = ` (ğŸ“‰ ${scoreDelta} from previous review)`;
    } else {
      scoreChange = ' (no change)';
    }
  }

  return `## ğŸ”¥ Karen has entered the chat

**Karen Score:** ${emoji} **${review.score.total}/100** - "${review.score.grade}"${scoreChange}

### The Reality Check

${review.summary}

### Issues Found

${review.issues.slice(0, 5).map(i => `- ${getSeverityEmoji(i.severity)} **${i.category}**: ${i.message}`).join('\n')}

${review.issues.length > 5 ? `\n_...and ${review.issues.length - 5} more issues_` : ''}

### Karen's Take

> ${review.bottomLine}

<details>
<summary>ğŸ“‹ Full Review</summary>

[View complete Karen review](.karen/review.md)

</details>

---

*Powered by [PRPM Karen](https://github.com/your-org/prompt-package-manager) ${emoji}*
`;
}

function getSeverityEmoji(severity: string): string {
  switch (severity) {
    case 'critical': return 'ğŸš¨';
    case 'high': return 'âš ï¸';
    case 'medium': return 'ğŸ“';
    case 'low': return 'ğŸ’¡';
    default: return 'â€¢';
  }
}
