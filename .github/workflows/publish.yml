name: Publish Packages

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version bump type'
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
          - prepatch
          - preminor
          - premajor
          - prerelease
      custom_version:
        description: 'Custom version (optional, overrides version type)'
        required: false
        type: string
      packages:
        description: 'Packages to publish (comma-separated: types,registry-client,cli or "all")'
        required: true
        default: 'all'
        type: string
      dry_run:
        description: 'Dry run (do not actually publish)'
        required: false
        type: boolean
        default: false
      tag:
        description: 'NPM dist-tag (latest, next, beta, alpha)'
        required: false
        type: choice
        options:
          - latest
          - next
          - beta
          - alpha
        default: 'latest'

permissions:
  contents: write
  id-token: write

jobs:
  validate:
    name: Validate and Test
    runs-on: ubuntu-latest
    env:
      NPM_CONFIG_FUND: false
    outputs:
      packages_to_publish: ${{ steps.determine.outputs.packages }}
      version_strategy: ${{ steps.version.outputs.version_strategy }}
      version_type: ${{ steps.version.outputs.version_type }}
      custom_version: ${{ steps.version.outputs.custom_version }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Build packages in dependency order
        run: |
          npm run build --workspace=@pr-pm/types
          npm run build --workspace=@pr-pm/converters
          npm run build --workspace=@pr-pm/registry-client
          npm run build --workspace=prpm

      - name: Determine packages to publish
        id: determine
        run: |
          PACKAGES="${{ github.event.inputs.packages }}"

          if [ "$PACKAGES" = "all" ]; then
            PUBLISH_PACKAGES='["types", "converters", "registry-client", "cli"]'
          else
            # Convert comma-separated to JSON array
            PUBLISH_PACKAGES=$(echo "$PACKAGES" | jq -R 'split(",") | map(select(length > 0))')
          fi

          echo "packages=$PUBLISH_PACKAGES" >> $GITHUB_OUTPUT
          echo "Will publish: $PUBLISH_PACKAGES"

      - name: Determine version
        id: version
        run: |
          CUSTOM_VERSION="${{ github.event.inputs.custom_version }}"
          VERSION_TYPE="${{ github.event.inputs.version }}"

          if [ -n "$CUSTOM_VERSION" ]; then
            echo "version_strategy=custom" >> $GITHUB_OUTPUT
            echo "custom_version=$CUSTOM_VERSION" >> $GITHUB_OUTPUT
            echo "Version strategy: custom ($CUSTOM_VERSION)"
          else
            echo "version_strategy=bump" >> $GITHUB_OUTPUT
            echo "version_type=$VERSION_TYPE" >> $GITHUB_OUTPUT
            echo "Version strategy: bump ($VERSION_TYPE)"
          fi

  version:
    name: Version All Packages
    needs: validate
    runs-on: ubuntu-latest
    env:
      NPM_CONFIG_FUND: false
    outputs:
      versions: ${{ steps.collect_versions.outputs.versions }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Build dependencies in order
        run: |
          npm run build --workspace=@pr-pm/types
          npm run build --workspace=@pr-pm/converters
          npm run build --workspace=@pr-pm/registry-client

      - name: Version all packages and update dependencies
        id: version_packages
        run: |
          PUBLISHED_PACKAGES='${{ needs.validate.outputs.packages_to_publish }}'
          VERSION_STRATEGY="${{ needs.validate.outputs.version_strategy }}"

          # Store new versions in a JSON object
          declare -A NEW_VERSIONS

          echo "=== Versioning packages in dependency order ==="

          # Version in dependency order: types â†’ converters â†’ registry-client â†’ cli
          DEPENDENCY_ORDER=("types" "converters" "registry-client" "cli")

          for pkg in "${DEPENDENCY_ORDER[@]}"; do
            # Skip if not in publish list
            if ! echo "$PUBLISHED_PACKAGES" | jq -e --arg pkg "$pkg" 'index($pkg) != null' > /dev/null; then
              echo "Skipping $pkg (not in publish list)"
              continue
            fi

            echo ""
            echo "--- Versioning $pkg ---"
            cd packages/$pkg

            # Determine new version
            if [ "$VERSION_STRATEGY" = "custom" ]; then
              TARGET_VERSION="${{ needs.validate.outputs.custom_version }}"
              echo "Setting version to custom value: $TARGET_VERSION"
              npm version "$TARGET_VERSION" --no-git-tag-version --allow-same-version
            else
              VERSION_TYPE="${{ needs.validate.outputs.version_type }}"
              CURRENT_VERSION=$(node -p "require('./package.json').version")
              echo "Current: $CURRENT_VERSION, Bumping: $VERSION_TYPE"
              npm version "$VERSION_TYPE" --no-git-tag-version --preid=beta
            fi

            NEW_VERSION=$(node -p "require('./package.json').version")

            echo "âœ“ $pkg versioned to $NEW_VERSION"
            NEW_VERSIONS[$pkg]=$NEW_VERSION

            # Update internal dependencies to NEW versions
            echo "Updating internal dependencies..."
            for dep_pkg in "${!NEW_VERSIONS[@]}"; do
              if [ "$dep_pkg" = "$pkg" ]; then
                continue  # Skip self
              fi

              # Determine package name
              if [ "$dep_pkg" = "cli" ]; then
                DEP_NAME="prpm"
              else
                DEP_NAME="@pr-pm/$dep_pkg"
              fi

              # Check if this package depends on it
              if grep -q "\"$DEP_NAME\"" package.json; then
                DEP_VERSION="${NEW_VERSIONS[$dep_pkg]}"
                echo "  Updating $DEP_NAME to ^$DEP_VERSION"

                node -e "
                  const fs = require('fs');
                  const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
                  if (pkg.dependencies && pkg.dependencies['$DEP_NAME']) {
                    pkg.dependencies['$DEP_NAME'] = '^$DEP_VERSION';
                    fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2) + '\n');
                  } else if (pkg.devDependencies && pkg.devDependencies['$DEP_NAME']) {
                    pkg.devDependencies['$DEP_NAME'] = '^$DEP_VERSION';
                    fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2) + '\n');
                  }
                "
              fi
            done

            cd ../..
          done

          echo ""
          echo "=== Version Summary ==="
          for pkg in "${!NEW_VERSIONS[@]}"; do
            echo "$pkg: ${NEW_VERSIONS[$pkg]}"
          done

      - name: Collect versions as JSON
        id: collect_versions
        run: |
          VERSIONS_JSON="{"
          PUBLISHED_PACKAGES='${{ needs.validate.outputs.packages_to_publish }}'

          FIRST=true
          echo "$PUBLISHED_PACKAGES" | jq -r '.[]' | while read pkg; do
            VERSION=$(node -p "require('./packages/$pkg/package.json').version")

            if [ "$FIRST" = true ]; then
              FIRST=false
            else
              VERSIONS_JSON+=","
            fi

            VERSIONS_JSON+="\"$pkg\":\"$VERSION\""
          done
          VERSIONS_JSON+="}"

          echo "versions=$VERSIONS_JSON" >> $GITHUB_OUTPUT
          echo "Collected versions: $VERSIONS_JSON"

      - name: Update root package-lock.json
        run: |
          echo "Updating root package-lock.json with new versions..."
          npm install --package-lock-only
          echo "âœ“ package-lock.json updated"

      - name: Upload versioned files
        uses: actions/upload-artifact@v4
        with:
          name: versioned-packages
          path: |
            packages/*/package.json
            package-lock.json
          retention-days: 1

  publish:
    name: Publish ${{ matrix.package }}
    needs: [validate, version]
    runs-on: ubuntu-latest
    env:
      NPM_CONFIG_FUND: false
    strategy:
      max-parallel: 1  # Publish sequentially to avoid race conditions
      matrix:
        package: ${{ fromJson(needs.validate.outputs.packages_to_publish) }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: package-lock.json
          registry-url: 'https://registry.npmjs.org'

      - name: Download versioned packages
        uses: actions/download-artifact@v4
        with:
          name: versioned-packages
          path: .

      - name: Install dependencies
        run: npm ci

      - name: Build dependencies in order
        run: |
          npm run build --workspace=@pr-pm/types
          npm run build --workspace=@pr-pm/converters
          npm run build --workspace=@pr-pm/registry-client

      - name: Build package
        run: |
          if [ "${{ matrix.package }}" = "cli" ]; then
            npm run build --workspace=prpm
          else
            npm run build --workspace=@pr-pm/${{ matrix.package }}
          fi

      - name: Get package version
        id: package_version
        run: |
          cd packages/${{ matrix.package }}
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Package version: $VERSION"

      - name: Dry run check
        if: github.event.inputs.dry_run == 'true'
        run: |
          cd packages/${{ matrix.package }}
          echo "Dry run - would publish:"
          npm pack --dry-run
          npm publish --dry-run --access public --tag ${{ github.event.inputs.tag }}

      - name: Publish to NPM
        if: github.event.inputs.dry_run != 'true'
        run: |
          cd packages/${{ matrix.package }}
          npm publish --access public --tag ${{ github.event.inputs.tag }}
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Report published
        run: |
          PKG_NAME="${{ matrix.package }}"
          if [ "$PKG_NAME" = "cli" ]; then
            echo "âœ… Published prpm@${{ steps.package_version.outputs.version }}"
          else
            echo "âœ… Published @pr-pm/${{ matrix.package }}@${{ steps.package_version.outputs.version }}"
          fi
          echo "NPM Tag: ${{ github.event.inputs.tag }}"

  create-git-tag:
    name: Create Git Tag and Release
    needs: [validate, version, publish]
    runs-on: ubuntu-latest
    env:
      NPM_CONFIG_FUND: false
    if: github.event.inputs.dry_run != 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Download versioned packages
        uses: actions/download-artifact@v4
        with:
          name: versioned-packages
          path: .

      - name: Determine versions from published packages
        id: collect_versions
        run: |
          PACKAGES='${{ needs.validate.outputs.packages_to_publish }}'
          VERSION_STRATEGY="${{ needs.validate.outputs.version_strategy }}"

          # If custom version was used, use that for the tag
          if [ "$VERSION_STRATEGY" = "custom" ]; then
            RELEASE_TAG="v${{ needs.validate.outputs.custom_version }}"
            echo "release_tag=$RELEASE_TAG" >> $GITHUB_OUTPUT
            echo "Using custom version tag: $RELEASE_TAG"
          else
            # Use timestamp-based tag for per-package bumps
            TIMESTAMP=$(date +%Y%m%d-%H%M%S)
            RELEASE_TAG="release-$TIMESTAMP"
            echo "release_tag=$RELEASE_TAG" >> $GITHUB_OUTPUT
            echo "Using timestamp tag: $RELEASE_TAG"
          fi

          # Collect current versions for release notes
          VERSIONS_LIST=""
          echo "$PACKAGES" | jq -r '.[]' | while read package; do
            VERSION=$(node -p "require('./packages/$package/package.json').version")
            if [ "$package" = "cli" ]; then
              echo "- prpm@$VERSION" >> /tmp/versions.txt
            else
              echo "- @pr-pm/$package@$VERSION" >> /tmp/versions.txt
            fi
          done

      - name: Commit version bumps
        run: |
          # Add all package.json files
          git add packages/*/package.json

          # Add root package-lock.json
          git add package-lock.json

          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No version changes to commit"
          else
            PACKAGES="${{ needs.validate.outputs.packages_to_publish }}"
            TAG="${{ github.event.inputs.tag }}"

            git commit -m "chore(release): publish packages" \
              -m "Published packages: ${PACKAGES}" \
              -m "NPM Tag: ${TAG}"

            git push origin main
            echo "âœ“ Version changes committed and pushed"
          fi

      - name: Create and push tag
        run: |
          RELEASE_TAG="${{ steps.collect_versions.outputs.release_tag }}"
          git tag -a "$RELEASE_TAG" -m "Release $RELEASE_TAG"
          git push origin "$RELEASE_TAG"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.collect_versions.outputs.release_tag }}
          name: Release ${{ steps.collect_versions.outputs.release_tag }}
          body: |
            ## Published Packages

            $(cat /tmp/versions.txt || echo "See package versions below")

            ### NPM Tag
            `${{ github.event.inputs.tag }}`

            ### Installation

            ```bash
            # Install latest CLI
            npm install -g prpm@latest

            # Or install specific versions listed above
            ```
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  summary:
    name: Publish Summary
    needs: [validate, publish, create-git-tag]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Summary
        run: |
          echo "## ðŸ“¦ NPM Publish Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version Strategy**: \`${{ needs.validate.outputs.version_strategy }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**NPM Tag**: \`${{ github.event.inputs.tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Dry Run**: \`${{ github.event.inputs.dry_run }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Published Packages" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # List packages (each was versioned independently)
          echo '${{ needs.validate.outputs.packages_to_publish }}' | jq -r '.[]' | while read pkg; do
            if [ "$pkg" = "cli" ]; then
              echo "- prpm (CLI)" >> $GITHUB_STEP_SUMMARY
            else
              echo "- @pr-pm/$pkg" >> $GITHUB_STEP_SUMMARY
            fi
          done

          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            echo "âš ï¸ **This was a dry run - no packages were actually published**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… **Packages successfully published to NPM**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Install latest CLI:" >> $GITHUB_STEP_SUMMARY
            echo '```bash' >> $GITHUB_STEP_SUMMARY
            echo "npm install -g prpm@latest" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
